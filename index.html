<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>שליטה - מערכת ניהול כוח אדם</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- Login Screen -->
    <div id="loginScreen" class="login-screen">
        <button id="loginThemeToggle" class="login-theme-btn" onclick="toggleTheme()" title="החלף עיצוב">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <div class="login-card">
            <div class="login-logo">
                <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/>
                    <path d="M2 17l10 5 10-5"/>
                    <path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <h1>שליטה</h1>
            <p class="login-subtitle">מערכת ניהול כוח אדם</p>
            <div class="login-form">
                <input type="password" id="passwordInput" placeholder="הזן סיסמה" autocomplete="off">
                <button id="loginBtn" onclick="handleLogin()">כניסה</button>
                <p id="loginError" class="login-error"></p>
            </div>
        </div>
    </div>

    <!-- Main App -->
    <div id="mainApp" class="main-app hidden">
        <!-- Sidebar -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <h2>שליטה</h2>
                <span id="accessLevel" class="access-badge"></span>
            </div>
            <ul class="nav-menu">
                <li class="nav-item active" data-view="personnel" onclick="switchView('personnel')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                    <span>כוח אדם</span>
                </li>
                <li class="nav-item" data-view="activities" onclick="switchView('activities')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg>
                    <span>פעילויות</span>
                </li>
                <li class="nav-item" data-view="cameras" onclick="switchView('cameras')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="3" width="20" height="14" rx="2" ry="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
                    <span>צלמים</span>
                </li>
                <li class="nav-item" data-view="dashboard" onclick="switchView('dashboard')">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                    <span>לוח בקרה</span>
                </li>
            </ul>
            <div class="sidebar-footer">
                <button id="themeToggle" class="theme-toggle" onclick="toggleTheme()" title="החלף עיצוב">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
                </button>
                <button class="logout-btn" onclick="handleLogout()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
                    יציאה
                </button>
            </div>
        </nav>

        <!-- Content -->
        <main class="content">
            <!-- Personnel View -->
            <div id="personnelView" class="view active">
                <div class="view-header">
                    <h2>ניהול כוח אדם</h2>
                    <div class="view-actions">
                        <button class="btn btn-secondary" onclick="openImportModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            ייבוא
                        </button>
                        <button class="btn btn-secondary" onclick="exportData()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            ייצוא
                        </button>
                        <button class="btn btn-secondary" onclick="openAddColumnModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            עמודה חדשה
                        </button>
                        <button class="btn btn-primary" onclick="openAddPersonModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="8.5" cy="7" r="4"/><line x1="20" y1="8" x2="20" y2="14"/><line x1="23" y1="11" x2="17" y2="11"/></svg>
                            הוסף איש
                        </button>
                    </div>
                </div>

                <!-- Filters (generated dynamically) -->
                <div id="filtersContainer" class="filters-bar"></div>

                <!-- Table -->
                <div class="table-container">
                    <table id="personnelTable">
                        <thead id="personnelHead"></thead>
                        <tbody id="personnelBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Activities View -->
            <div id="activitiesView" class="view">
                <div class="view-header">
                    <h2>ניהול פעילויות</h2>
                    <div class="view-actions">
                        <button class="btn btn-secondary" onclick="document.getElementById('importActivitiesInput').click()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                            ייבוא פעילויות
                        </button>
                        <input type="file" id="importActivitiesInput" accept=".json" style="display:none" onchange="importActivitiesFile(event)">
                        <button class="btn btn-secondary" onclick="exportActivities()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            ייצוא פעילויות
                        </button>
                        <button class="btn btn-primary" onclick="openNewActivityModal()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                            פעילות חדשה
                        </button>
                    </div>
                </div>

                <div id="activitiesList" class="activities-list"></div>
            </div>

            <!-- Cameras View -->
            <div id="camerasView" class="view">
                <div class="view-header">
                    <h2>מעקב צלמים</h2>
                    <div class="view-actions">
                        <button class="btn btn-secondary" onclick="exportCameras()">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                            ייצוא
                        </button>
                    </div>
                </div>
                <div class="table-container cameras-table-container">
                    <table id="camerasTable">
                        <thead id="camerasHead"></thead>
                        <tbody id="camerasBody"></tbody>
                    </table>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboardView" class="view">
                <div class="view-header">
                    <h2>לוח בקרה</h2>
                </div>
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-icon blue">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="totalPersonnel">0</span>
                            <span class="stat-label">סה"כ כוח אדם</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon green">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="totalActivities">0</span>
                            <span class="stat-label">פעילויות פעילות</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon orange">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="totalTeams">0</span>
                            <span class="stat-label">צוותים</span>
                        </div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon purple">
                            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
                        </div>
                        <div class="stat-info">
                            <span class="stat-value" id="avgCompletion">0%</span>
                            <span class="stat-label">ממוצע השלמת פעילויות</span>
                        </div>
                    </div>
                </div>

                <div class="dashboard-section">
                    <h3>פעילויות אחרונות</h3>
                    <div id="recentActivities" class="recent-activities"></div>
                </div>

                <div class="dashboard-section">
                    <h3>חלוקה לפי צוותים</h3>
                    <div id="teamBreakdown" class="team-breakdown"></div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Add Person -->
    <div id="addPersonModal" class="modal-overlay hidden">
        <div class="modal">
            <div class="modal-header">
                <h3 id="addPersonModalTitle">הוסף איש חדש</h3>
                <button class="modal-close" onclick="closeModal('addPersonModal')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="addPersonForm">
                    <div id="personFormFields"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('addPersonModal')">ביטול</button>
                <button class="btn btn-primary" onclick="savePerson()">שמור</button>
            </div>
        </div>
    </div>

    <!-- Modal: Add Column -->
    <div id="addColumnModal" class="modal-overlay hidden">
        <div class="modal modal-sm">
            <div class="modal-header">
                <h3>הוסף עמודה חדשה</h3>
                <button class="modal-close" onclick="closeModal('addColumnModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>שם העמודה</label>
                    <input type="text" id="columnName" placeholder="הזן שם עמודה">
                </div>
                <div class="form-group">
                    <label>סוג</label>
                    <select id="columnType">
                        <option value="text">טקסט</option>
                        <option value="number">מספר</option>
                        <option value="boolean">כן/לא</option>
                        <option value="date">תאריך</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('addColumnModal')">ביטול</button>
                <button class="btn btn-primary" onclick="addColumn()">הוסף</button>
            </div>
        </div>
    </div>

    <!-- Modal: New Activity -->
    <div id="newActivityModal" class="modal-overlay hidden">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>פעילות חדשה</h3>
                <button class="modal-close" onclick="closeModal('newActivityModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>שם הפעילות</label>
                    <input type="text" id="activityName" placeholder="הזן שם פעילות">
                </div>
                <div class="form-group">
                    <label>תיאור</label>
                    <textarea id="activityDescription" placeholder="תיאור הפעילות" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>תאריך יעד</label>
                    <input type="date" id="activityDeadline">
                </div>

                <hr>
                <h4>בחר משתתפים</h4>

                <div id="actFiltersContainer" class="filters-bar compact"></div>

                <div class="select-actions">
                    <button class="btn btn-ghost btn-sm" onclick="selectAllFiltered()">בחר הכל</button>
                    <button class="btn btn-ghost btn-sm" onclick="deselectAllFiltered()">בטל בחירה</button>
                    <span id="selectedCount" class="count-badge">0 נבחרו</span>
                </div>

                <div class="participants-list" id="participantsList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('newActivityModal')">ביטול</button>
                <button class="btn btn-primary" onclick="createActivity()">צור פעילות</button>
            </div>
        </div>
    </div>

    <!-- Modal: Activity Detail -->
    <div id="activityDetailModal" class="modal-overlay hidden">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3 id="activityDetailTitle"></h3>
                <button class="modal-close" onclick="closeModal('activityDetailModal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="activity-detail-info">
                    <p id="activityDetailDesc"></p>
                    <div class="activity-meta">
                        <span id="activityDetailDeadline"></span>
                        <span id="activityDetailCreated"></span>
                    </div>
                </div>
                <div class="progress-section">
                    <div class="progress-header">
                        <span>התקדמות</span>
                        <span id="activityProgressText">0%</span>
                    </div>
                    <div class="progress-bar">
                        <div class="progress-fill" id="activityProgressBar"></div>
                    </div>
                    <div class="progress-stats">
                        <span id="activityCompletedCount">0 השלימו</span>
                        <span id="activityRemainingCount">0 נותרו</span>
                    </div>
                </div>

                <div class="detail-filters">
                    <input type="text" id="detailSearchInput" placeholder="חיפוש משתתף..." oninput="filterDetailParticipants()">
                    <select id="detailFilterStatus" onchange="filterDetailParticipants()">
                        <option value="">הכל</option>
                        <option value="completed">השלימו</option>
                        <option value="pending">טרם השלימו</option>
                    </select>
                </div>

                <div class="detail-participants-list" id="detailParticipantsList"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-danger" onclick="deleteCurrentActivity()">מחק פעילות</button>
                <button class="btn btn-ghost" onclick="closeModal('activityDetailModal')">סגור</button>
            </div>
        </div>
    </div>

    <!-- Modal: Import Data -->
    <div id="importModal" class="modal-overlay hidden">
        <div class="modal modal-lg">
            <div class="modal-header">
                <h3>ייבוא נתונים</h3>
                <button class="modal-close" onclick="closeModal('importModal')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Step 1: File Upload -->
                <div id="importStep1">
                    <div class="import-drop-zone" id="importDropZone">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                            <polyline points="17 8 12 3 7 8"/>
                            <line x1="12" y1="3" x2="12" y2="15"/>
                        </svg>
                        <p>גרור קובץ לכאן או לחץ לבחירה</p>
                        <span class="import-formats">CSV, XLSX, XLS</span>
                        <input type="file" id="importFileInput" accept=".csv,.xlsx,.xls" style="display:none" onchange="handleImportFileSelect(event)">
                    </div>
                </div>

                <!-- Step 2: Column Configuration -->
                <div id="importStep2" class="hidden">
                    <div class="import-step-header">
                        <h4>הגדרת עמודות</h4>
                        <span id="importRowCount" class="count-badge"></span>
                    </div>
                    <div class="import-config-table-wrap">
                        <table class="import-config-table">
                            <thead>
                                <tr>
                                    <th>כלול</th>
                                    <th>שם עמודה</th>
                                    <th>עמודה ראשית</th>
                                    <th>סינון</th>
                                </tr>
                            </thead>
                            <tbody id="importConfigBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-ghost" onclick="closeModal('importModal')">ביטול</button>
                <button id="importConfirmBtn" class="btn btn-primary hidden" onclick="confirmImport()">ייבוא</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast hidden"></div>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.3/package/dist/xlsx.full.min.js"></script>
    <script src="app.js"></script>
</body>
</html>
